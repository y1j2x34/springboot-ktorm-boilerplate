# 生产环境部署检查清单

## ✅ 部署前检查

### 环境准备
- [ ] Docker 和 Docker Compose 已安装并正常运行
- [ ] 服务器满足最低硬件要求 (4GB RAM, 2 CPU, 20GB 磁盘)
- [ ] 防火墙规则已正确配置
- [ ] SSL 证书已准备（如需要）
- [ ] 域名 DNS 已配置

### 配置文件
- [ ] 已从 `.env.prod.example` 创建 `.env.prod`
- [ ] 所有密码使用强密码（至少 16 字符）
- [ ] 不同服务使用不同密码
- [ ] `.env.prod` 权限设置为 600
- [ ] `.env.prod` 未提交到版本控制
- [ ] 数据库配置正确
- [ ] Logto 端点配置正确

### 数据存储
- [ ] 数据目录已创建 (`/var/lib/springboot-ktorm-app`)
- [ ] 目录权限正确设置 (700)
- [ ] 磁盘空间充足（至少 20GB 可用）
- [ ] 备份策略已制定

### 数据库
- [ ] MariaDB 配置文件已优化
- [ ] PostgreSQL 配置文件已优化
- [ ] 初始化 SQL 脚本已准备
- [ ] 数据库备份脚本已配置

### 应用配置
- [ ] `application-prod.yml` 已配置
- [ ] JVM 参数已根据服务器调整
- [ ] 日志级别设置为 INFO
- [ ] 日志轮转已配置
- [ ] 健康检查端点已启用

## ✅ 安全检查

### 网络安全
- [ ] 仅必要的端口对外开放
- [ ] 数据库端口不对外暴露
- [ ] 使用内部网络隔离数据库
- [ ] 配置反向代理（Nginx/Traefik）
- [ ] HTTPS/TLS 已配置

### 访问控制
- [ ] 数据库使用非 root 用户访问
- [ ] 容器以非 root 用户运行
- [ ] 使用 `no-new-privileges` 安全选项
- [ ] 敏感文件设置只读权限

### 密码管理
- [ ] 所有默认密码已更改
- [ ] 密码复杂度符合要求
- [ ] Grafana 默认密码已更改
- [ ] 密码轮换计划已制定

## ✅ 监控和日志

### 监控配置
- [ ] Prometheus 配置正确
- [ ] Grafana 数据源已配置
- [ ] 告警规则已设置
- [ ] 告警通知渠道已配置
- [ ] 监控面板已导入

### 日志管理
- [ ] 日志收集已配置（Loki/Promtail）
- [ ] 日志保留期已设置
- [ ] 日志大小限制已配置
- [ ] 慢查询日志已启用

## ✅ 备份策略

### 数据备份
- [ ] 数据库备份脚本已测试
- [ ] 备份目录已创建
- [ ] Cron 任务已设置
- [ ] 备份保留策略已配置
- [ ] 备份恢复流程已测试

### 应用备份
- [ ] Docker 镜像已标记版本
- [ ] 配置文件已备份
- [ ] 数据卷备份策略已制定

## ✅ 性能优化

### 数据库优化
- [ ] 连接池大小已调整
- [ ] 缓冲池大小已优化
- [ ] 慢查询阈值已设置
- [ ] 索引已优化

### 应用优化
- [ ] JVM 堆大小已优化
- [ ] GC 参数已调整
- [ ] 连接超时已配置
- [ ] 线程池大小已调整

### 系统优化
- [ ] 文件描述符限制已增加
- [ ] TCP 参数已优化
- [ ] 磁盘 I/O 已优化

## ✅ 测试验证

### 功能测试
- [ ] 应用可正常启动
- [ ] 健康检查端点返回正常
- [ ] API 接口可正常访问
- [ ] 数据库连接正常
- [ ] Logto 认证流程正常

### 性能测试
- [ ] 负载测试已执行
- [ ] 响应时间符合要求
- [ ] 并发处理能力达标
- [ ] 资源使用在可控范围

### 安全测试
- [ ] 端口扫描已执行
- [ ] 漏洞扫描已执行
- [ ] SQL 注入测试已通过
- [ ] XSS 攻击测试已通过

## ✅ 部署执行

### 部署步骤
- [ ] 代码已拉取最新版本
- [ ] 依赖已更新
- [ ] 构建成功无错误
- [ ] 旧版本已停止
- [ ] 新版本已启动
- [ ] 健康检查通过

### 部署验证
- [ ] 所有容器状态正常
- [ ] 服务响应正常
- [ ] 日志无错误信息
- [ ] 监控数据正常
- [ ] 告警配置生效

## ✅ 上线后检查

### 立即检查（5 分钟内）
- [ ] 服务可访问
- [ ] 健康检查正常
- [ ] 无错误日志
- [ ] CPU/内存使用正常

### 短期检查（1 小时内）
- [ ] 响应时间正常
- [ ] 无内存泄漏
- [ ] 数据库连接稳定
- [ ] 无异常告警

### 持续监控（24 小时内）
- [ ] 服务稳定运行
- [ ] 性能指标正常
- [ ] 无系统告警
- [ ] 用户反馈正常

## ✅ 文档和交接

### 文档完整性
- [ ] 部署文档已更新
- [ ] 配置说明已记录
- [ ] 故障排除指南已准备
- [ ] API 文档已更新

### 运维交接
- [ ] 运维团队已培训
- [ ] 监控访问权限已分配
- [ ] 紧急联系方式已更新
- [ ] 回滚计划已准备

## ✅ 应急准备

### 回滚计划
- [ ] 回滚脚本已准备
- [ ] 回滚步骤已测试
- [ ] 数据回滚方案已制定
- [ ] 回滚决策流程已明确

### 故障响应
- [ ] 故障处理流程已建立
- [ ] 紧急联系人已确定
- [ ] 故障排查手册已准备
- [ ] 备用方案已制定

---

## 签字确认

| 角色 | 姓名 | 签字 | 日期 |
|------|------|------|------|
| 开发负责人 |  |  |  |
| 运维负责人 |  |  |  |
| 测试负责人 |  |  |  |
| 项目经理 |  |  |  |

---

**注意事项:**
1. 所有检查项必须完成后才能上线
2. 如有未完成项，需评估风险并制定解决方案
3. 保留此检查清单作为部署记录
4. 定期回顾和更新检查清单

